<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>Frontline Terminal</title>
  <script defer data-domain="csfs64.github.io" src="https://plausible.io/js/script.outbound-links.pageview-props.tagged-events.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css">
  <script>
    function loadContent(id, path, callback) {
      const container = document.getElementById(id);
      if (container.dataset.loaded === "true") {
        if (callback) callback();
        return;
      }

      fetch(path)
        .then(response => response.text())
        .then(html => {
          container.innerHTML = html;
          container.dataset.loaded = "true";

          const threadContainers = container.querySelectorAll('.thread');
          threadContainers.forEach(thread => {
            const threadItems = thread.querySelectorAll('.thread-item');
            if (threadItems.length > 0) {
              threadItems[0].style.display = 'block';
              threadItems.forEach((item, index) => {
                if (index > 0) item.style.display = 'none';
              });
            }
          });

          if (callback) callback();
        })
        .catch(() => {
          container.innerHTML = "<p>⚠️ 加载失败。</p>";
        });
    }
  </script>
</head>
<body>
  <h1>📡 FRONTLINE TERMINAL</h1>
  <p class="timestamp_lastupdate" style="cursor: pointer;">最后更新：加载中...</p>

  <details>
    <summary onclick="loadContent('day-2025-06-04', 'days/2025-06-04.html')">📅 2025-06-04（星期三）</summary>
    <div id="day-2025-06-04" data-loaded="false"><p>加载中...</p></div>
  </details>

  <details>
    <summary onclick="loadContent('day-2025-06-03', 'days/2025-06-03.html')">📅 2025-06-03（星期二）</summary>
    <div id="day-2025-06-03" data-loaded="false"><p>加载中...</p></div>
  </details>

  <hr>
  <p><em>你可以通过在bilibili给我充电来支持我的工作</em></p>

  <script>
    let jumpTarget = null;

    document.addEventListener("DOMContentLoaded", function () {
      const updateElement = document.querySelector(".timestamp_lastupdate");
      const allDetails = document.querySelectorAll("details");

      if (allDetails.length === 0) return;

      const latestDetails = allDetails[0];
      const summary = latestDetails.querySelector("summary");
      const onclick = summary.getAttribute("onclick");
      const match = onclick.match(/loadContent\(['"](.+?)['"]\s*,\s*['"](.+?)['"]\)/);
      if (!match) return;

      const divId = match[1];
      const htmlPath = match[2];

      fetch(htmlPath)
        .then(response => response.text())
        .then(html => {
          const container = document.getElementById(divId);
          container.innerHTML = html;
          container.dataset.loaded = "true";

          const threadContainers = container.querySelectorAll('.thread');
          threadContainers.forEach(thread => {
            const threadItems = thread.querySelectorAll('.thread-item');
            if (threadItems.length > 0) {
              threadItems[0].style.display = 'block';
              threadItems.forEach((item, index) => {
                if (index > 0) item.style.display = 'none';
              });
            }
          });

          const dateMatch = summary.textContent.match(/\d{4}-\d{2}-\d{2}/);
          const latestDate = dateMatch ? dateMatch[0] : "未知日期";

          const tempDiv = document.createElement("div");
          tempDiv.innerHTML = html;

          let latestMinutes = -1;
          let latestText = "";
          let latestEventTitle = "";
          let threadId = "";

          const allDetailsInHtml = tempDiv.querySelectorAll("details");
          allDetailsInHtml.forEach((detail, detailIndex) => {
            const eventTitle = detail.querySelector("summary")?.textContent.replace(/\s+/g, ' ').trim() || "[未知事件]";
            const threadItems = detail.querySelectorAll(".thread-item");

            threadItems.forEach((item, threadIndex) => {
              const timestampDiv = item.querySelector(".timestamp");
              const rawTime = timestampDiv?.textContent.trim() || "";
              const match = rawTime.match(/(\d{1,2}):(\d{2})/);

              if (match) {
                const hours = parseInt(match[1], 10);
                const minutes = parseInt(match[2], 10);
                const total = hours * 60 + minutes;

                if (total > latestMinutes) {
                  latestMinutes = total;
                  const firstP = item.querySelector("p");
                  latestText = firstP?.textContent.trim().slice(0, 6) || "";
                  latestEventTitle = eventTitle;
                  threadId = `jump-${latestDate}-${eventTitle}-${hours}-${minutes}`;
                }
              }
            });
          });

          updateElement.textContent = `最后更新（点击跳转）：${latestDate} ${latestEventTitle}：${latestText}...`;
          updateElement.dataset.jump = threadId;

        })
        .catch(() => {
          updateElement.textContent = "最后更新：⚠️ 获取失败";
        });
    });

    // 点击“最后更新”跳转功能
    document.addEventListener("click", function (e) {
      const target = e.target;
      if (target.classList.contains("timestamp_lastupdate")) {
        const jumpId = target.dataset.jump;
        if (!jumpId) return;

        const firstDetails = document.querySelector("details");
        const summary = firstDetails.querySelector("summary");
        summary.click(); // 触发展开并加载

        loadContent('day-2025-06-04', 'days/2025-06-04.html', () => {
          const container = document.getElementById('day-2025-06-04');
          const detailElements = container.querySelectorAll("details");
          detailElements.forEach(detail => {
            const summary = detail.querySelector("summary");
            if (!detail.open) summary.click();

            // 展开全文按钮
            const btn = detail.querySelector(".expand-thread");
            if (btn && !detail.classList.contains("expanded")) btn.click();
          });

          const threadItem = container.querySelector(".thread-item:last-child");
          if (threadItem) threadItem.scrollIntoView({ behavior: "smooth" });
        });
      }
    });

    // 手动“展开全部”按钮功能
    document.addEventListener("click", function (e) {
      if (e.target.classList.contains("expand-thread")) {
        const button = e.target;
        const thread = button.closest("details");
        const threadItems = thread.querySelectorAll(".thread-item");

        if (thread.classList.contains("expanded")) {
          thread.classList.remove("expanded");
          button.textContent = "📖 展开全部";
          threadItems.forEach((item, index) => {
            if (index !== 0) item.style.display = "none";
          });
        } else {
          thread.classList.add("expanded");
          button.textContent = "📚 收起";
          threadItems.forEach(item => item.style.display = "block");
        }
      }
    });
  </script>

  <!-- 图片放大模态框 -->
  <div id="image-modal" class="modal" onclick="closeModal()">
    <img id="modal-image" class="modal-image" src="">
  </div>

  <script>
    document.addEventListener('click', function (e) {
      if (e.target.classList.contains('separator-image')) {
        const modal = document.getElementById('image-modal');
        const modalImg = document.getElementById('modal-image');
        modal.style.display = 'flex';
        modalImg.src = e.target.src;
      }
    });

    function closeModal() {
      document.getElementById('image-modal').style.display = 'none';
    }

    document.addEventListener('keydown', function (e) {
      if (e.key === "Escape") {
        closeModal();
      }
    });

    document.addEventListener("dblclick", e => e.preventDefault());
    document.addEventListener("contextmenu", e => e.preventDefault());
    document.addEventListener("keydown", e => {
      if (e.key === "F12" || (e.ctrlKey && e.shiftKey && e.key === "I")) {
        e.preventDefault();
      }
    });
  </script>
</body>
</html>
