<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>Frontline Terminal</title>
  <script defer data-domain="csfs64.github.io" src="https://plausible.io/js/script.outbound-links.pageview-props.tagged-events.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css">
  <script>
    let jumpTargetId = null;

    function loadContent(id, path, callback) {
      const container = document.getElementById(id);
      if (container.dataset.loaded === "true") {
        callback && callback();
        return;
      }

      fetch(path)
        .then(response => response.text())
        .then(html => {
          container.innerHTML = html;
          container.dataset.loaded = "true";

          const threadContainers = container.querySelectorAll('.thread');
          threadContainers.forEach(thread => {
            const threadItems = thread.querySelectorAll('.thread-item');
            if (threadItems.length > 0) {
              threadItems[0].style.display = 'block';
              threadItems.forEach((item, index) => {
                if (index > 0) item.style.display = 'none';
              });
            }
          });

          callback && callback();
        })
        .catch(() => {
          container.innerHTML = "<p>âš ï¸ åŠ è½½å¤±è´¥ã€‚</p>";
        });
    }
  </script>
</head>
<body>
  <h1>ğŸ“¡ FRONTLINE TERMINAL</h1>
  <p class="timestamp_lastupdate" style="cursor: pointer; text-decoration: underline;">æœ€åæ›´æ–°ï¼šåŠ è½½ä¸­...</p>

  <details>
    <summary onclick="loadContent('day-2025-06-04', 'days/2025-06-04.html')">ğŸ“… 2025-06-04ï¼ˆæ˜ŸæœŸä¸‰ï¼‰</summary>
    <div id="day-2025-06-04" data-loaded="false"><p>åŠ è½½ä¸­...</p></div>
  </details>

  <details>
    <summary onclick="loadContent('day-2025-06-03', 'days/2025-06-03.html')">ğŸ“… 2025-06-03ï¼ˆæ˜ŸæœŸäºŒï¼‰</summary>
    <div id="day-2025-06-03" data-loaded="false"><p>åŠ è½½ä¸­...</p></div>
  </details>

  <hr>
  <p><em>ä½ å¯ä»¥é€šè¿‡åœ¨bilibiliç»™æˆ‘å……ç”µæ¥æ”¯æŒæˆ‘çš„å·¥ä½œ</em></p>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const updateElement = document.querySelector(".timestamp_lastupdate");
      const allDetails = document.querySelectorAll("details");
      if (allDetails.length === 0) return;

      const latestDetails = allDetails[0];
      const summary = latestDetails.querySelector("summary");
      const onclick = summary.getAttribute("onclick");
      const match = onclick.match(/loadContent\(['"](.+?)['"]\s*,\s*['"](.+?)['"]\)/);
      if (!match) return;

      const divId = match[1];
      const htmlPath = match[2];

      fetch(htmlPath)
        .then(response => response.text())
        .then(html => {
          const container = document.getElementById(divId);
          container.innerHTML = html;
          container.dataset.loaded = "true";

          const tempDiv = document.createElement("div");
          tempDiv.innerHTML = html;

          let latestTime = "00:00";
          let latestText = "";
          let latestEventTitle = "";
          let targetThreadId = "";

          const allDetailsInHtml = tempDiv.querySelectorAll("details");
          allDetailsInHtml.forEach((detail, dIndex) => {
            const eventTitle = detail.querySelector("summary")?.textContent.replace(/\s+/g, ' ').trim() || "[æœªçŸ¥äº‹ä»¶]";
            const threadItems = detail.querySelectorAll(".thread-item");

            threadItems.forEach((item, iIndex) => {
              const timestampDiv = item.querySelector(".timestamp");
              const rawTime = timestampDiv?.textContent.trim() || "";
              const timeMatch = rawTime.match(/\b\d{1,2}:\d{2}\b/);
              if (timeMatch) {
                const timeStr = timeMatch[0];
                if (timeStr > latestTime) {
                  latestTime = timeStr;
                  const firstP = item.querySelector("p");
                  latestText = firstP?.textContent.trim().slice(0, 6) || "";
                  latestEventTitle = eventTitle;
                  targetThreadId = `jump-${dIndex}-${iIndex}`;

                  // ç»™çœŸå® DOM æ·»åŠ  ID ç”¨äºå®šä½
                  const realDetails = container.querySelectorAll("details")[dIndex];
                  const realThread = realDetails?.querySelectorAll(".thread-item")[iIndex];
                  if (realThread) realThread.id = targetThreadId;
                }
              }
            });
          });

          updateElement.textContent = `æœ€åæ›´æ–°ï¼ˆç‚¹å‡»è·³è½¬ï¼‰ï¼š${divId.slice(4)} ${latestEventTitle}ï¼š${latestText}...`;
          jumpTargetId = targetThreadId;
        })
        .catch(() => {
          updateElement.textContent = "æœ€åæ›´æ–°ï¼šâš ï¸ è·å–å¤±è´¥";
        });

      // æ·»åŠ ç‚¹å‡»è·³è½¬é€»è¾‘
      updateElement.addEventListener("click", () => {
        const detail = document.getElementById(divId)?.closest("details");
        if (!detail.open) detail.open = true;

        loadContent(divId, htmlPath, () => {
          const threadItem = document.getElementById(jumpTargetId);
          if (!threadItem) return;

          // æ‰¾åˆ°æ‰€å± details å…ƒç´ ï¼Œå±•å¼€å…¨æ–‡
          const detailsWrapper = threadItem.closest("details");
          if (detailsWrapper && !detailsWrapper.classList.contains("expanded")) {
            const expandBtn = detailsWrapper.querySelector(".expand-thread");
            if (expandBtn) expandBtn.click();
          }

          setTimeout(() => {
            threadItem.scrollIntoView({ behavior: "smooth", block: "center" });
          }, 100);
        });
      });
    });
  </script>
</body>
</html>
