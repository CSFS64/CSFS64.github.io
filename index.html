<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>Frontline Terminal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css">
  <script defer data-domain="csfs64.github.io" src="https://plausible.io/js/script.outbound-links.pageview-props.tagged-events.js"></script>
</head>
<body>
  <h1>📡 FRONTLINE TERMINAL</h1>
  <p class="timestamp_lastupdate">最后更新：2025-06-04</p>

  <!-- 更新日志区域 -->
  <details id="update-log" class="update-log">
    <summary id="latest-update-summary">📢 最新更新：加载中...</summary>
    <ul id="update-list"></ul>
  </details>

  <!-- 每日更新区域 -->
  <details>
    <summary onclick="loadContent('day-2025-06-04', 'days/2025-06-04.html')">📅 2025-06-04（星期三）</summary>
    <div id="day-2025-06-04" data-loaded="false">
      <p>加载中...</p>
    </div>
  </details>

  <details>
    <summary onclick="loadContent('day-2025-06-03', 'days/2025-06-03.html')">📅 2025-06-03（星期二）</summary>
    <div id="day-2025-06-03" data-loaded="false">
      <p>加载中...</p>
    </div>
  </details>

  <details>
    <summary onclick="loadContent('day-2025-06-02', 'days/2025-06-02.html')">📅 2025-06-02（暂时不要点，会出bug）</summary>
    <div id="day-2025-06-02" data-loaded="false">
      <p>加载中...</p>
    </div>
  </details>

  <hr>
  <p><em>你可以通过在 bilibili 给我充电来支持我的工作</em></p>

  <!-- 图片放大模态框 -->
  <div id="image-modal" class="modal" onclick="closeModal()">
    <img id="modal-image" class="modal-image" src="">
  </div>

  <script>
    function loadContent(id, path) {
      const container = document.getElementById(id);
      if (container.dataset.loaded === "true") return;

      fetch(path)
        .then(response => response.text())
        .then(html => {
          container.innerHTML = html;
          container.dataset.loaded = "true";

          const temp = document.createElement('div');
          temp.innerHTML = html;
          const summaries = temp.querySelectorAll('summary');
          const updateList = document.getElementById('update-list');
          updateList.innerHTML = '';

          summaries.forEach((summary, index) => {
            const text = summary.textContent.trim();
            const anchorId = `event-${id}-${index}`;
            summary.setAttribute('id', anchorId);

            const li = document.createElement('li');
            li.innerHTML = `<a href="#${anchorId}">${text}</a>`;
            li.querySelector('a').addEventListener('click', () => {
              expandAndScroll(id, anchorId, '');
            });
            updateList.appendChild(li);
          });

          const firstSummary = temp.querySelector('summary');
          const allThreads = temp.querySelectorAll('.thread');
          if (firstSummary && allThreads.length > 0) {
            const threadItems = allThreads[0].querySelectorAll('.thread-item');
            const last = threadItems[threadItems.length - 1];
            const previewText = (last.textContent || '').trim().slice(0, 6);
            if (!last.id) last.id = `${firstSummary.id}-latest-thread`;

            const logSummary = document.getElementById('latest-update-summary');
            logSummary.innerHTML = `<a href="#" onclick="expandAndScroll('${id}', '${firstSummary.id}', '${last.id}')">📢 最新更新：${firstSummary.textContent.trim()}：${previewText}...</a>`;
          }
        })
        .catch(() => {
          container.innerHTML = "<p>⚠️ 加载失败。</p>";
        });
    }

    function expandAndScroll(dayId, summaryId, threadId) {
      loadContent(dayId, `days/${dayId.replace('day-', '')}.html`);

      setTimeout(() => {
        const dayDetails = document.getElementById(dayId).closest('details');
        dayDetails.open = true;

        setTimeout(() => {
          const summary = document.getElementById(summaryId);
          if (summary) {
            summary.click();
            setTimeout(() => {
              const expandBtn = summary.parentElement.querySelector('.expand-thread');
              if (expandBtn) expandBtn.click();
              if (threadId) {
                const thread = document.getElementById(threadId);
                if (thread) thread.scrollIntoView({ behavior: 'smooth' });
              }
            }, 300);
          }
        }, 300);
      }, 500);
    }

    document.addEventListener("DOMContentLoaded", function () {
      loadContent("day-2025-06-04", "days/2025-06-04.html");

      const threads = document.querySelectorAll('.thread');
      threads.forEach(thread => {
        const threadItems = thread.querySelectorAll('.thread-item');
        threadItems[0].style.display = 'block';
        threadItems.forEach((item, index) => {
          if (index > 0) item.style.display = 'none';
        });
      });
    });

    function expandThread(button) {
      const thread = button.closest('details');
      const items = thread.querySelectorAll('.thread-item');
      if (thread.classList.contains('expanded')) {
        thread.classList.remove('expanded');
        button.textContent = "📖 展开全部";
        items.forEach((item, index) => {
          if (index !== 0) item.style.display = 'none';
        });
      } else {
        thread.classList.add('expanded');
        button.textContent = "📚 收起";
        items.forEach(item => item.style.display = 'block');
      }
    }

    document.addEventListener('click', function (e) {
      if (e.target.classList.contains('separator-image')) {
        const modal = document.getElementById('image-modal');
        const modalImg = document.getElementById('modal-image');
        modal.style.display = 'flex';
        modalImg.src = e.target.src;
      }
    });

    function closeModal() {
      document.getElementById('image-modal').style.display = 'none';
    }

    document.addEventListener('keydown', function (e) {
      if (e.key === "Escape") closeModal();
    });

    document.addEventListener("dblclick", e => e.preventDefault());
    document.addEventListener("contextmenu", e => e.preventDefault());
    document.addEventListener("keydown", e => {
      if (e.key === "F12" || (e.ctrlKey && e.shiftKey && e.key === "I")) {
        e.preventDefault();
      }
    });
  </script>
</body>
</html>
