<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>Frontline Terminal</title>
  <script defer data-domain="csfs64.github.io" src="https://plausible.io/js/script.outbound-links.pageview-props.tagged-events.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css">
  <script>
    // æ ‡è®°å½“å¤©æ‰€æœ‰ thread ä¸­æ—¶é—´æœ€æ–°çš„ä¸€ä¸ªä¸º id="latest-thread"
    function markLatestThread(container) {
      let latestMinutes = -1;
      let latestItem = null;
      container.querySelectorAll(".thread-item").forEach(item => {
        const raw = item.querySelector(".timestamp")?.textContent || "";
        const match = raw.match(/(\d{1,2}):(\d{2})/);
        if (match) {
          const min = parseInt(match[1]) * 60 + parseInt(match[2]);
          if (min > latestMinutes) {
            latestMinutes = min;
            latestItem = item;
          }
        }
      });
      if (latestItem) {
        latestItem.setAttribute("id", "latest-thread");
      }
    }

    // åŠ è½½æŸä¸ªæ—¥æœŸçš„ HTML æ–‡ä»¶å†…å®¹ï¼Œæ’å…¥æŒ‡å®šå®¹å™¨
    function loadContent(id, path, callback) {
      const container = document.getElementById(id);
      if (container.dataset.loaded === "true") {
        if (callback) requestAnimationFrame(() => callback());
        return;
      }

      fetch(path)
        .then(response => response.text())
        .then(html => {
          container.innerHTML = html;
          container.dataset.loaded = "true";

          // é»˜è®¤åªæ˜¾ç¤ºæ¯ä¸ª thread çš„ç¬¬ä¸€ä¸ªæ¡ç›®
          const threadContainers = container.querySelectorAll('.thread');
          threadContainers.forEach(thread => {
            const threadItems = thread.querySelectorAll('.thread-item');
            if (threadItems.length > 0) {
              threadItems[0].style.display = 'block';
              threadItems.forEach((item, index) => {
                if (index > 0) item.style.display = 'none';
              });
            }
          });

          // è®¾ç½®æœ€æ–°æ¡ç›®çš„ ID
          setTimeout(() => {
            markLatestThread(container);
            if (callback) callback();
          }, 0);
        })
        .catch(() => {
          container.innerHTML = "<p>âš ï¸ åŠ è½½å¤±è´¥ã€‚</p>";
        });
    }
  </script>
</head>
<body>
  <h1>ğŸ“¡ FRONTLINE TERMINAL</h1>
  <p class="timestamp_lastupdate" style="cursor: pointer;">æœ€åæ›´æ–°ï¼šåŠ è½½ä¸­...</p>

  <!-- æ¯æ—¥è¯¦æƒ…éƒ¨åˆ† -->
  <details>
    <summary onclick="loadContent('day-2025-06-04', 'days/2025-06-04.html')">ğŸ“… 2025-06-04ï¼ˆæ˜ŸæœŸä¸‰ï¼‰</summary>
    <div id="day-2025-06-04" data-loaded="false"><p>åŠ è½½ä¸­...</p></div>
  </details>

  <details>
    <summary onclick="loadContent('day-2025-06-03', 'days/2025-06-03.html')">ğŸ“… 2025-06-03ï¼ˆæ˜ŸæœŸäºŒï¼‰</summary>
    <div id="day-2025-06-03" data-loaded="false"><p>åŠ è½½ä¸­...</p></div>
  </details>

  <hr>
  <p><em>ä½ å¯ä»¥é€šè¿‡åœ¨bilibiliç»™æˆ‘å……ç”µæ¥æ”¯æŒæˆ‘çš„å·¥ä½œ</em></p>

  <!-- é¡µé¢åŠ è½½åè‡ªåŠ¨æ£€æµ‹å¹¶æ˜¾ç¤ºâ€œæœ€åæ›´æ–°â€ä¿¡æ¯ -->
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const updateElement = document.querySelector(".timestamp_lastupdate");
      const allDetails = document.querySelectorAll("details");

      const latestDetails = allDetails[0];
      const summary = latestDetails.querySelector("summary");
      const onclick = summary.getAttribute("onclick");
      const match = onclick.match(/loadContent\(['"](.+?)['"]\s*,\s*['"](.+?)['"]\)/);
      if (!match) return;

      const divId = match[1];
      const htmlPath = match[2];

      fetch(htmlPath)
        .then(response => response.text())
        .then(html => {
          const container = document.getElementById(divId);
          container.innerHTML = html;
          container.dataset.loaded = "true";

          const tempDiv = document.createElement("div");
          tempDiv.innerHTML = html;

          let latestMinutes = -1;
          let latestText = "";
          let latestEventTitle = "";

          const allDetailsInHtml = tempDiv.querySelectorAll("details");
          allDetailsInHtml.forEach(detail => {
            const eventTitle = detail.querySelector("summary")?.textContent.trim() || "[æœªçŸ¥äº‹ä»¶]";
            const threadItems = detail.querySelectorAll(".thread-item");

            threadItems.forEach(item => {
              const rawTime = item.querySelector(".timestamp")?.textContent || "";
              const match = rawTime.match(/(\d{1,2}):(\d{2})/);
              if (match) {
                const total = parseInt(match[1]) * 60 + parseInt(match[2]);
                if (total > latestMinutes) {
                  latestMinutes = total;
                  const firstP = item.querySelector("p");
                  latestText = firstP?.textContent.trim().slice(0, 6) || "";
                  latestEventTitle = eventTitle;
                }
              }
            });
          });

          const dateMatch = summary.textContent.match(/\d{4}-\d{2}-\d{2}/);
          const latestDate = dateMatch ? dateMatch[0] : "æœªçŸ¥æ—¥æœŸ";
          updateElement.textContent = `æœ€åæ›´æ–°ï¼ˆç‚¹å‡»è·³è½¬ï¼‰ï¼š${latestDate} ${latestEventTitle}ï¼š${latestText}...`;
        })
        .catch(() => {
          updateElement.textContent = "æœ€åæ›´æ–°ï¼šâš ï¸ è·å–å¤±è´¥";
        });
    });

    // ç‚¹å‡»â€œæœ€åæ›´æ–°â€åè·³è½¬åˆ°æœ€æ–°æ¡ç›®ï¼Œå¹¶å±•å¼€ç›¸å…³åŒºåŸŸ
    document.addEventListener("click", function (e) {
      if (e.target.classList.contains("timestamp_lastupdate")) {
        const updateEl = e.target;
        const originalText = updateEl.textContent;
        updateEl.dataset.original = originalText;

        // ğŸ”¸ æ‰“å­—åŠ¨ç”»ï¼šâ€œæ­£åœ¨å®šä½ â–ˆâ€
        let text = " æ­£åœ¨å®šä½";
        let index = 0;
        const typing = setInterval(() => {
          if (index <= text.length) {
            updateEl.textContent = originalText + text.slice(0, index) + " â–ˆ";
            index++;
          } else {
            clearInterval(typing);
          }
        }, 120);

        // ğŸ”¸ å±•å¼€å½“å¤© <details>
        const todayDetails = document.querySelector("details");
        todayDetails.open = true;

        // ğŸ”¸ åŠ è½½å½“å¤© HTML
        loadContent('day-2025-06-04', 'days/2025-06-04.html', () => {
          const container = document.getElementById('day-2025-06-04');
          markLatestThread(container);

          // â±ï¸ ç­‰â€œæ­£åœ¨å®šä½â€æ‰“å°å®Œ â†’ å»¶è¿Ÿ 1000ms å†è·³è½¬
          setTimeout(() => {
            const latestItem = document.getElementById("latest-thread");
            if (!latestItem) {
              updateEl.textContent = updateEl.dataset.original + "ï¼ˆæœªæ‰¾åˆ°ç›®æ ‡ï¼‰";
              return;
            }

            // ğŸ”¸ å±•å¼€å…¶æ‰€åœ¨äº‹ä»¶ details
            const eventDetails = latestItem.closest("details");
            if (eventDetails) eventDetails.open = true;

            // ğŸ”¸ å±•å¼€å…¶æ‰€å± thread
            const thread = latestItem.closest(".thread");
            if (thread) {
              thread.querySelectorAll(".thread-item").forEach(i => i.style.display = "block");

              const expandBtn = thread.querySelector(".expand-thread");
              if (expandBtn) {
                thread.classList.add("expanded");
                expandBtn.textContent = "ğŸ“š æ”¶èµ·";
                expandBtn.dataset.expanded = "true";
              }
            }

            // ğŸ”¸ æ»šåŠ¨å®šä½å¹¶åœ¨å®Œæˆåæ¸…é™¤â€œæ­£åœ¨å®šä½â€
            latestItem.scrollIntoView({ behavior: "smooth", block: "center" });
            setTimeout(() => {
              updateEl.textContent = updateEl.dataset.original;
            }, 300);
          }, 1000);
        });
      }
    });

    // å¤„ç†â€œå±•å¼€å…¨éƒ¨â€æŒ‰é’®çš„ç‚¹å‡»åˆ‡æ¢è¡Œä¸º
    document.addEventListener("click", function (e) {
      if (e.target.classList.contains("expand-thread")) {
        const button = e.target;
        const thread = button.closest("details, .thread");
        const threadItems = thread.querySelectorAll(".thread-item");

        const isExpanded = thread.classList.contains("expanded") || button.dataset.expanded === "true";

        if (isExpanded) {
          thread.classList.remove("expanded");
          button.textContent = "ğŸ“– å±•å¼€å…¨éƒ¨";
          button.dataset.expanded = "false";
          threadItems.forEach((item, index) => {
            if (index !== 0) item.style.display = "none";
          });
        } else {
          thread.classList.add("expanded");
          button.textContent = "ğŸ“š æ”¶èµ·";
          button.dataset.expanded = "true";
          threadItems.forEach(item => item.style.display = "block");
        }
      }
    });
  </script>

  <!-- å›¾ç‰‡ç‚¹å‡»æ”¾å¤§æŸ¥çœ‹åŠŸèƒ½ -->
  <div id="image-modal" class="modal" onclick="closeModal()">
    <img id="modal-image" class="modal-image" src="">
  </div>
  <script>
    document.addEventListener('click', function (e) {
      if (e.target.classList.contains('separator-image')) {
        const modal = document.getElementById('image-modal');
        const modalImg = document.getElementById('modal-image');
        modal.style.display = 'flex';
        modalImg.src = e.target.src;
      }
    });
    function closeModal() {
      document.getElementById('image-modal').style.display = 'none';
    }

    // å¿«æ·é”®/å³é”®é˜²æŠ¤
    document.addEventListener('keydown', function (e) {
      if (e.key === "Escape") closeModal();
      if (e.key === "F12" || (e.ctrlKey && e.shiftKey && e.key === "I")) {
        e.preventDefault();
      }
    });
    document.addEventListener("dblclick", e => e.preventDefault());
    document.addEventListener("contextmenu", e => e.preventDefault());
  </script>
</body>
</html>
