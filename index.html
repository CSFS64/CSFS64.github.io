<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>Frontline Terminal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css">
  <script defer data-domain="csfs64.github.io" src="https://plausible.io/js/script.outbound-links.pageview-props.tagged-events.js"></script>
  <script>
    function loadContent(id, path, callback) {
      const container = document.getElementById(id);
      if (container.dataset.loaded === "true") {
        if (callback) callback(container);
        return;
      }
      fetch(path)
        .then(response => response.text())
        .then(html => {
          container.innerHTML = html;
          container.dataset.loaded = "true";
          if (callback) callback(container);
        })
        .catch(() => {
          container.innerHTML = "<p>⚠️ 加载失败。</p>";
        });
    }

    function toggleThread(thread, expand) {
      const items = thread.querySelectorAll('.thread-item');
      thread.classList.toggle('expanded', expand);
      items.forEach((item, index) => {
        item.style.display = expand || index === 0 ? 'block' : 'none';
      });
      const button = thread.querySelector('.expand-thread');
      if (button) button.textContent = expand ? '📚 收起' : '📖 展开全部';
    }

    document.addEventListener("DOMContentLoaded", function () {
      const updateEl = document.querySelector(".timestamp_lastupdate");
      const allDetails = document.querySelectorAll("details");
      if (allDetails.length === 0) return;

      const latestDetails = allDetails[0];
      const summary = latestDetails.querySelector("summary");
      const onclick = summary.getAttribute("onclick");
      const match = onclick.match(/loadContent\(['"](.+?)['"]\s*,\s*['"](.+?)['"]\)/);
      if (!match) return;

      const divId = match[1];
      const htmlPath = match[2];

      fetch(htmlPath)
        .then(r => r.text())
        .then(html => {
          const tempDiv = document.createElement("div");
          tempDiv.innerHTML = html;

          let latestTime = "00:00";
          let latestText = "";
          let latestEventTitle = "";
          let latestThreadIndex = -1;

          const allEventDetails = tempDiv.querySelectorAll("details");
          allEventDetails.forEach(detail => {
            const title = detail.querySelector("summary")?.textContent.trim() || "[未知事件]";
            const threadItems = detail.querySelectorAll(".thread-item");
            threadItems.forEach((item, idx) => {
              const timeDiv = item.querySelector(".timestamp");
              const rawTime = timeDiv?.textContent.trim() || "";
              const timeMatch = rawTime.match(/\b\d{1,2}:\d{2}\b/);
              if (timeMatch && timeMatch[0] > latestTime) {
                latestTime = timeMatch[0];
                latestText = item.querySelector("p")?.textContent.trim().slice(0, 6) || "";
                latestEventTitle = title;
                latestThreadIndex = idx;
              }
            });
          });

          updateEl.textContent = `最后更新（点击跳转）：${match[1].slice(4)} ${latestEventTitle}：${latestText}...`;

          // 保存跳转信息
          window._latestJump = {
            containerId: divId,
            path: htmlPath,
            eventTitle: latestEventTitle,
            threadIndex: latestThreadIndex
          };
        });

      // 事件委托绑定展开/收起按钮
      document.addEventListener("click", e => {
        if (e.target.classList.contains("expand-thread")) {
          const thread = e.target.closest("details").querySelector(".thread");
          const expanded = thread.classList.contains("expanded");
          toggleThread(thread, !expanded);
        }
      });

      // 点击跳转到最新 thread
      document.querySelector(".timestamp_lastupdate").addEventListener("click", () => {
        const info = window._latestJump;
        if (!info) return;

        const dayDetails = document.querySelector(`div#${info.containerId}`).closest("details");
        dayDetails.open = true;

        loadContent(info.containerId, info.path, container => {
          const eventDetails = [...container.querySelectorAll("details")].find(d =>
            d.querySelector("summary")?.textContent.trim() === info.eventTitle
          );
          if (!eventDetails) return;

          eventDetails.open = true;
          const thread = eventDetails.querySelector(".thread");
          toggleThread(thread, true);
          const items = thread.querySelectorAll(".thread-item");
          if (items[info.threadIndex]) {
            items[info.threadIndex].scrollIntoView({ behavior: "smooth", block: "center" });
          }
        });
      });
    });
  </script>
</head>
<body>
  <h1>📡 FRONTLINE TERMINAL</h1>
  <p class="timestamp_lastupdate">最后更新：加载中...</p>

  <details>
    <summary onclick="loadContent('day-2025-06-04', 'days/2025-06-04.html')">📅 2025-06-04（星期三）</summary>
    <div id="day-2025-06-04" data-loaded="false"><p>加载中...</p></div>
  </details>

  <details>
    <summary onclick="loadContent('day-2025-06-03', 'days/2025-06-03.html')">📅 2025-06-03（星期二）</summary>
    <div id="day-2025-06-03" data-loaded="false"><p>加载中...</p></div>
  </details>

  <hr>
  <p><em>你可以通过在bilibili给我充电来支持我的工作</em></p>
</body>
</html>
